%\documentclass[a4paper,12pt,twoside,french]{book}
\documentclass[a5paper,10pt,twoside,french]{book}
\usepackage{pdfpages}
\usepackage[culdelampe,littera]{fauve}
%\usepackage[squarebr]{gmverse}
\usepackage{array}
\usepackage{longtable}
\usepackage{coffee4}
\usepackage{amsmath}
\usepackage{enotez} % notes de fin
\usepackage{footmisc} % référence sur les footnotes
\usepackage{zxjatype}
\usepackage[ipa]{zxjafont}
\usepackage{afterpage}
\usepackage{needspace}
\usepackage{tabstackengine}
\usepackage{tabularx,booktabs}
\usepackage{lscape}
\usepackage{newunicodechar}
\usepackage[strict]{changepage}
\usepackage{etoolbox}
\usepackage{xcolor}
\usepackage{afterpage}
\usepackage{ragged2e}
\usepackage{setspace}
\usepackage{wrapfig}
\usepackage{tikz}
\usepackage{fancyhdr}
\usepackage{xpatch}
\usepackage{lipsum}
\usepackage{eso-pic} % Ce paquet permet d’insérer le qrcode à un endroit fixe, avec, pour origine du repère, le coint haut gauche.
\usepackage{wallpaper}
\usepackage{shapepar}
\usepackage{paracol}
\usepackage{bm}
\usepackage{xinttools}
\usepackage{allrunes}
\usepackage{makeidx}
\usepackage{marginnote}
\usepackage[absolute,overlay]{textpos}
\usepackage{imakeidx}
\usepackage{xifthen} % provides \isempty test
\usepackage{amsmath}
\usepackage{multirow}
\usepackage{pst-barcode}

%\usepackage{slantsc}
%\usepackage{fontaxes}
%\usepackage{ebgaramond}
%\usepackage[noGFSDidotTS1]{gfsdidot}
%\usepackage{reledmac}
\usetikzlibrary{shapes}
\usetikzlibrary{calc,positioning,fit,intersections}
\usetikzlibrary{shapes.geometric}

\bibliography{./dag.bib}
\makeindex[title=Index thématique]
\makeindex[name=rhymes, columns=3, title=Index des rimes, columns=3]
\makeindex[name=metric,title=Index des vers]
\makeindex[name=strophy,title=Index des strophes]

\graphicspath{{img/}}


\definecolor{creme}{HTML}{ECDCAB}
\definecolor{rouge}{HTML}{C2302A}
\definecolor{noir}{HTML}{41413B}

\newcommand\didot{
\setmainfont[
  Mapping=tex-text,
  BoldFont=GFSDidotBold.otf]{GFSDidot.otf}
}

%\newcommand\ebgaramond{
%  \setmainfont{EBGaramond12-Regular}
%}

\input Typocaps.fd
\newcommand*\digobro{\usefont{U}{Typocaps}{xl}{n}}

\newif\ifnormalLT
\normalLTtrue

\makeatletter
\patchcmd {\LT@start}
          {\vfil \break}
          {\ifnormalLT \vfil \break \fi}
          {\typeout{Patching longtable succeeded!}}
          {\typeout{Patching longtable failed!}\ERROR}
\patchcmd {\LT@start}
          {\penalty \z@}
          {\ifnormalLT \penalty \z@ \fi}
          {\typeout{Patching longtable succeeded!}}
          {\typeout{Patching longtable failed!}\ERROR}
\makeatother


\XeTeXcharclass`’=\XeTeXcharclass`A
\XeTeXcharclass`…=\XeTeXcharclass`A
\XeTeXcharclass`—=\XeTeXcharclass`A

\geometry{a5paper}

\input{meta.tex}            % Déffinition des métadonnées.

%\renewcommand{\poemtitlefont}{\raggedright\normalfont\large\bfseries\hspace{\leftmargin}}
\renewcommand{\poemtitlefont}{\raggedright\normalfont\large\bfseries\hspace{\leftmargin}}

%\makeatletter
%\renewcommand{\@vstypeptitle}[1]{%
%  \vspace{\beforepoemtitleskip}
%  {\poemtitlefont #1\par\nobreak}\nobreak
%  \vspace{\afterpoemtitleskip}\nobreak
%}
%\makeatother
\makeatletter
\renewcommand{\@vstypeptitle}[1]{%
  \vspace{\beforepoemtitleskip}
  {\poemtitlefont #1\par\nobreak}\nobreak
  \vspace{\afterpoemtitleskip}\nobreak
}
\makeatother

\makeatletter
\def\hardnobreakpar{\par\nobreak\@afterheading} 
\makeatother


\newcolumntype{L}[1]{>{\raggedright\let\newline\\\arraybackslash\hspace{0pt}}p{#1}}
\newcolumntype{C}[1]{>{\centering\let\newline\\\arraybackslash\hspace{0pt}}p{#1}}
\newcolumntype{R}[1]{>{\raggedleft\let\newline\\\arraybackslash\hspace{0pt}}p{#1}}

\newfontfamily\arabicfont[Ligatures=TeX,Script=Arabic]{Amiri}
\newcommand{\hieroglyphs}[1]{{\setromanfont{Post-Hadrian-Gate.ttf}#1}}


\setotherlanguages{greek,russian,arabic}
\usepackage{titling}

%\pretitle{%
%  \vspace{-5em}
%  \begin{center}
%  \LARGE
%  \includegraphics[height=2cm]{F.pdf}\\[\bigskipamount]
%}
%\posttitle{\end{center}}

%*****************************************  *% poème flotant <<<<<<<<<<<<<<
\DeclareFloatingEnvironment{floatpoemenv}

\newenvironment{floatpoem}
{\begin{floatpoemenv}[!ht]}
{\end{floatpoemenv}}
%*********************************************************


%\newcommand\BrText[1]{%
%  \par\smallskip%
%   \noindent\makebox[\textwidth-1cm][r]{$\text{Refrain}\left\{
%    \hspace{-0.5cm}\begin{minipage}{\textwidth}%
%    \begin{verse}%
%    #1
%    \end{verse}
%    \end{minipage}
%  \right.\nulldelimiterspace=-14pt$}\smallskip
%}    

\newcommand\BrText[1]{%
  \par\smallskip%
   \noindent\makebox[\textwidth-3.3cm][r]{$\text{Refrain}\left\{
    \hspace{-0.7cm}\begin{minipage}{\textwidth}%
    \vspace{-6pt}
    \begin{verse}%
    #1
    \end{verse}
    \end{minipage}
  \right.\nulldelimiterspace=-14pt$}\smallskip
}    

\newenvironment{prose}
{\em\small\paragraph{}}
{}


\newcommand\fullpageillustartion[1]
{
\begin{figure}[p]
    \vspace*{-2cm}
    \makebox[\linewidth]{
        \includegraphics[width=1.3\linewidth]{#1}
    }
\end{figure}
}

\setenotez{list-heading=\chapter*{#1}\markboth{#1}{#1}, list-name=Notes}
\renewcommand{\poemtoc}{subsection}

\input{apparence.tex}       % page de titre

\setlength{\belowcaptionskip}{-20pt}

\fancyhf{}

\fancypagestyle{fancy2}{%
  \renewcommand{\chaptermark}[1]{\markboth{\MakeUppercase{\chaptername\ \thechapter. {##1}}}{}}
}

\makeatletter
\pagestyle{fancy2}
\fancyhead[LE,RO]{\thepage}
\fancyhead[LO]{\MakeUppercase{\rightmark}}
\fancyhead[RE]{\MakeUppercase{\@title}}
%\setlength{\headheight}{14.7pt}

\patchcmd{\chaptermark}{\@chapapp\ }{}{}{}
\renewcommand{\headrulewidth}{0pt}
\makeatother

%\sethangingsymbol{[\,}

%\AtBeginDocument{%
%  \xpatchcmd{\verse}
%    {\penalty10000 \vfil\penalty\betweenstanzaspenalty\vfilneg\relax}
%    {\penalty\betweenstanzaspenalty}
%    {}{}%
%}

\newcommand\authorshape{% 
%{5}             %line center at x=7
%{0}  b{0}\\     % text starts at (0,0)
%{0}  t{0}{10}\\ % Line at y=0 starts at x=0 with length 14
%{10} t{0}{10}\\ % Line at y=10 starts at x=0 with length 14
%{15} t{5}{0}\\  % Line at y=15 starts at x=7 with length 0
%{15} t{4}{0}\\  % Line at y=15 starts at x=7 with length 0
%{15} e{5}       % text ends at (7,15)
{5}             %line center at x=7
{0}  b{0}\\     % text starts at (0,0)
{0}  t{0}{10}\\ % Line at y=0 starts at x=0 with length 14
{12} t{0}{10}\\ % Line at y=10 starts at x=0 with length 14
{14} t{5}{0}\\  % Line at y=15 starts at x=7 with length 0
{15} t{4}{0}\\  % Line at y=15 starts at x=7 with length 0
{16} e{3}       % text ends at (7,15)
}

\makeatletter
\newunicodechar{⸮}{%
  {%
  \,%\NoAutoSpacing%
  \iffontchar\font`⸮
    ⸮%
  \else%
    \ifdim\fontdimen1\font=\z@%
    \tikz[baseline=(?.base),inner sep=0pt,outer sep=0pt]\node[xscale=-1] (?) {{\NoAutoSpacing?}};%
    \else%
    {\NoAutoSpacing\tikz[baseline=(?.base),inner sep=0pt,outer sep=0pt]\node[xscale=-1,xslant=-0.5](?){\NoAutoSpacing?};\kern-0.36em}%
    \fi%
  \fi%
  }%
}
\makeatother

%\setlength\LTpre{0em} \setlength\LTpost{0em}

\newcommand\currentpoemtitle{}
\newcommand\altcurrentpoemtitle{}

\newcommand\test{machin}

\newcommand{\rhyme}[2][]
{%
  \ifthenelse{\isempty{#1}} %
    {\index[rhymes]{#2@-#2!\altcurrentpoemtitle@\emph{\currentpoemtitle}}}%               % if no title option given
    {\index[rhymes]{#1@-#2!\altcurrentpoemtitle@\emph{\currentpoemtitle}}}%    % if title given
}

\renewcommand{\rhyme}[2][]
{%
  \ifthenelse{\isempty{#1}} %
    {\index[rhymes]{#2@-#2}}%               % if no title option given
    {\index[rhymes]{#1@-#2}}%    % if title given
}

%\newcommand{\rhyme}[2]
%{%
%  \index[rhymes]{#1@-#2!\emph{\currentpoemtitle}}%
%}

\newcommand{\putinmetricindex}[2]
{
  \index[metric]{#1@#2!\altcurrentpoemtitle@\emph{\currentpoemtitle}}
}

\newcommand{\metric}[1]
{%
  \ifthenelse{ \equal{#1}{1} }%
  {\putinmetricindex{01}{Monosyllabes}%
  }{}%
%
  \ifthenelse{ \equal{#1}{2} }%
  {\putinmetricindex{02}{Dissyllabes}%
  }{}%
%
%
  \ifthenelse{ \equal{#1}{3} }%
  {\putinmetricindex{03}{Trisyllabes}%
  }{}%
%
%
  \ifthenelse{ \equal{#1}{4} }%
  {\putinmetricindex{04}{Tétrasyllabes}%
  }{}%
%
%
  \ifthenelse{ \equal{#1}{5} }%
  {\putinmetricindex{05}{Pentasyllabes}%
  }{}%
%
%
  \ifthenelse{ \equal{#1}{6} }%
  {\putinmetricindex{06}{Hexasyllabes}%
  }{}%
%
%
  \ifthenelse{ \equal{#1}{7} }%
  {\putinmetricindex{07}{Heptasyllabes}%
  }{}%
%
%
  \ifthenelse{ \equal{#1}{8} }%
  {\putinmetricindex{08}{Octosyllabes}%
  }{}%
%
%
  \ifthenelse{ \equal{#1}{9} }%
  {\putinmetricindex{09}{Ennéasyllabes}%
  }{}%
%
%
  \ifthenelse{ \equal{#1}{10} }%
  {\putinmetricindex{10}{Décasyllabes}%
  }{}%
%
%
  \ifthenelse{ \equal{#1}{11} }%
  {\putinmetricindex{11}{Hendécasyllabes}%
  }{}%
%
%
  \ifthenelse{ \equal{#1}{12} }%
  {\putinmetricindex{12}{Alexandrins}%
  }{}%
%
  \ifthenelse{ \equal{#1}{13} }%
  {\putinmetricindex{13}{Décatrisyllabes}%
  }{}%
%
  \ifthenelse{ \equal{#1}{14} }%
  {\putinmetricindex{14}{Décatesserasyllabes}%
  }{}%
%
  \ifthenelse{ \equal{#1}{15} }%
  {\putinmetricindex{15}{Décapentasyllabes}%
  }{}%
%
  \ifthenelse{ \equal{#1}{18} }%
  {\putinmetricindex{18}{Décaoctoyllabes}%
  }{}%
}




\newcommand{\putinstrophyindex}[2]
{
  \index[strophy]{#1@#2!\altcurrentpoemtitle@\emph{\currentpoemtitle}}
}

\newcommand{\haiku}
{
  \putinstrophyindex{31}{Haïkus!1@Haïkus 5–7–5}
}

\newcommand{\haikuII}
{
  \putinstrophyindex{31}{Haïkus!2@Haïkus 5–5–7}
}

\newcommand{\haikuIII}
{
  \putinstrophyindex{31}{Haïkus!3@Haïkus 7–5–5}
}

\newcommand{\monostique}
{
  \putinstrophyindex{10}{Monostiques}
}
\newcommand{\distique}
{
  \putinstrophyindex{20}{Distiques}
}
\newcommand{\tercet}
{
  \putinstrophyindex{30}{Tercets}
}
\newcommand{\quatrain}
{
  \putinstrophyindex{40}{Quatrains}
}
\newcommand{\quintil}
{
  \putinstrophyindex{50}{Quintils}
}
\newcommand{\sizain}
{
  \putinstrophyindex{60}{Sizains}
}
\newcommand{\septain}
{
  \putinstrophyindex{70}{Septains}
}
\newcommand{\huitain}
{
  \putinstrophyindex{80}{Huitains}
}
\newcommand{\neuvain}
{
  \putinstrophyindex{90}{Neuvains}
}
\newcommand{\dizain}
{
  \putinstrophyindex{100}{Dizains}
}
\newcommand{\onzain}
{
  \putinstrophyindex{110}{Onzains}
}
\newcommand{\douzain}
{
  \putinstrophyindex{120}{Douzains}
}
\newcommand{\treizain}
{
  \putinstrophyindex{130}{Treizains}
}
\newcommand{\quatorzain}
{
  \putinstrophyindex{140}{Quatorzains}
}
\newcommand{\calligramme}
{
  \putinstrophyindex{141}{Calligrames}
}

\newcommand{\setIndexNameEntry}[2][]
{%
  \ifthenelse{\isempty{#1}}%
    {%               % if no title option given
      \renewcommand\currentpoemtitle{#2}%
      \renewcommand\altcurrentpoemtitle{#2}%
    }%
    {
      \renewcommand\currentpoemtitle{#2}%
      \renewcommand\altcurrentpoemtitle{#1}%
    }    % if title given
}

\let\OLDpoemtitle\poemtitle
\renewcommand{\poemtitle}[2][]{%
  \setIndexNameEntry{#2} %
  \ifthenelse{\isempty{#1}} %
    {\OLDpoemtitle{#2}}               % if no title option given
    {\OLDpoemtitle[#1]{#2}}    % if title given
}

\newcommand\price{73,00}

\def\MADsymbolA{%
  \leavevmode
  \vtop{\offinterlineskip %\bfseries
    \setbox0=\hbox{D}%
    \setbox2=\hbox to\wd0{\hfil\hskip-.03em
    \vrule height .3ex width .15ex\hskip .08em
    \vrule height .3ex width .15ex\hfil}
    \vbox{\copy2\box0}\box2}}

\def\MADsymbolB{\leavevmode
  {\setbox0=\hbox{{D}}%
    \dimen0\ht0 \advance\dimen0 0.2ex
    \ooalign{\hfil \box0\hfil\cr
      \hfil\vrule height \dimen0 depth.2ex\hfil\cr
    }%
  }%
}

\newcommand\MADsymbol{\MADsymbolB{}}



\begin{document}
  \DTMsetdatestyle{fauvedate}
  \maketitle

  \frontmatter

{
\thispagestyle{empty}
\chapter*{}
\thispagestyle{empty}

  \null\vfill           % Pression du haut pour condenser les informations de crédit en bas de la page.
    \begin{center}
      \includegraphics[width=3cm]{coeur-poignarde-monochrome.pdf}
 
      \LARGE {D’AMOUR \emph{\&} DE GUERRE}

      \vspace*{20pt}

      \large { \includegraphics[height=1em]{logo-rouge-sur-noir.pdf} }
    \end{center}
    \vspace*{150pt}
  \vfill                % Espace vértical.

}
{
\thispagestyle{empty}
\chapter*{}
\thispagestyle{empty}

  \null\vfill           % Pression du haut pour condenser les informations de crédit en bas de la page.
    \begin{flushright}
      \emph{%
      À F*****
      }
    \end{flushright}
  \vspace*{130pt}
  \vfill                % Espace vértical.
}

  \mainmatter
  \input{contenu.tex}       % L’œuvre proprement dite.

 % \newpage
  \backmatter
  \cleardoublepage

  \addcontentsline{toc}{section}{Table des matières}
  \tableofcontents

  \addcontentsline{toc}{section}{Notes}
  \printendnotes

  \addcontentsline{toc}{section}{Index des thèmes}
  \printindex

  \addcontentsline{toc}{section}{Index des rimes}
  \printindex[rhymes]

  \addcontentsline{toc}{section}{Index des vers}
  \printindex[metric]

  \addcontentsline{toc}{section}{Index des strophes}
  \printindex[strophy]

  \addcontentsline{toc}{section}{Table des illustrations}
  \listoffigures

  \input{auteur.tex}

  \newpage
  \thispagestyle{empty}
  \addcontentsline{toc}{section}{Carré du cauchemar}
  \renewcommand\currentpoemtitle{carré du cauchemar}%
  \quintil%
  \metric{1}\metric{2}

  \topskip0pt
  \vspace*{\fill}
  \Large
  \begin{center}
    \setstackTAB{ }
    \fixTABwidth{T}
    \tabbedCenterstack{
A F \textbf{F} R E\\
Q U \textbf{A} N D\\
\textbf{F} \textbf{A} \textbf{U} \textbf{V} \textbf{E}\\
R Ê \textbf{V} Â T\\
H I \textbf{E} R \phantom{,}S\phantom{,}
}
  \end{center}
  \vspace*{\fill}\null

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% 4eme de couv
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  \clearpage
%  \pagestyle{empty}

%  ~

  \ifodd\value{page} ~ \else \clearpage\pagecolor{creme}\pagestyle{empty}\newpage\pagestyle{empty} \fi%



%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  \pagestyle{empty}%
%  \clearpage%

  \newgeometry{left=1cm, right=1cm, top=25mm, bottom=0mm}%
  \pagecolor{creme}%
  \color{noir}%
  \center%
  \renewcommand\currentpoemtitle{Quatrième de couverture}%
  \index{Artistes!René Magritte}


  \includegraphics[height=8cm]{chat-de-sable.pdf}

  \vskip 0.65cm

  {
  \begin{minipage}[t]{0.6\textwidth}%
  \begin{justify}
  \fontsize{10pt}{10pt}\selectfont{}%
  \lettrine[lines=3]{\digobro{}\color{rouge}M}{agritte} n’aurait pas mieux dit. \enquote{{\color{rouge}Ceci n’est pas une quatrième de couverture}} artifice que les Anglais désignent de l’écœurant nom de \xenism{blurb}, on y entendrait presque l’onomatopée du vomissement tant la luette racle le fond de la gorge. Et encore… la chose demeure trop joliment dite.
%
%Quelle étrangeté d’un monde céphalopode que les premières pages que l’on ai lu d’un livre en soient les dernières. À toutes ces absurdités, nous nous sommes refusé d’être les complices.
%
Ce serait alors gâter la beauté que nous avons voulu mettre dans ce livre que de le doter d’une pareille ignominie qui prend le lecteur de haut et l’enjoins à faire sien un point de vue. Et pourquoi d’ailleurs le lester d’une quatrième de couverture lorsque vous pourriez le feuilleter et en lire des extraits dès à présent\ironie
  \end{justify}
  \end{minipage}%
  }
 
  \begin{textblock*}{3cm}(11.8cm,19.3cm) 
    \StrMid{\price}{1}{4}[\country]
    \newcommand\pricenaturalpart{\StrBefore{\price}{,}}
    \newcommand\pricedecimalpart{\StrBehind{\price}{,}}
    {
    \color{rouge}%
    %
    %
    \addtolength{\tabcolsep}{-7pt}
    \begin{tabular}{rl}
      \multirow{2}{*}{\fontsize{1.8cm}{1em}\selectfont\pricenaturalpart} &\fontsize{0.6cm}{1em}\selectfont,\pricedecimalpart \\
                                                                         &\phantom{{\fontsize{0.6cm}{1em}\selectfont,}}\fontsize{0.8cm}{1em}\selectfont \MADsymbol
    \end{tabular}
    }
  \end{textblock*}


  \begin{textblock*}{\paperwidth}(0.1em,17.6cm) 
    \color{rouge}%
    \begin{pspicture}(3.5,1.2in)
      \psbarcode{0-00000-000}{includetext textcolor=C2302A barcolor=C2302A textfont="Liberation Sans" isbntextfont="Anonymous Pro" height=0.5}{isbn}
    \end{pspicture}
  \end{textblock*}


\vfill\null

\end{document}
